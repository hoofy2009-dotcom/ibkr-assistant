# Finnhub API 集成指南

## 🎯 功能介绍

通过集成 Finnhub API，扩展现在可以获取：

### 1. **分析师评级** 📊 ✅ 免费版可用
- 评级分布（强烈买入/买入/持有/卖出/强烈卖出）
- 分析师共识（综合推荐）
- ~~目标价（最低/最高/平均/中位数）~~ ⚠️ 需付费版

### 2. **机构持股** 🏦 ⚠️ 需付费版
- ~~机构持股比例~~
- ~~前5大机构持有人~~
- ~~机构持股变化趋势（增持/减持/稳定）~~

> **提示**：免费版只提供分析师推荐评级，已经足够用于判断市场共识！

---

## 📝 获取 API 密钥（免费）

### 步骤 1：注册账号
1. 访问：https://finnhub.io/register
2. 填写邮箱、密码
3. 点击 **Sign Up**

### 步骤 2：获取 API Key
1. 注册成功后自动跳转到Dashboard
2. 在页面顶部找到 **API Key** 区域
3. 复制显示的密钥（格式如：`xxxxxxxxxxxxxxxxxx`）

### 步骤 3：配置到扩展
1. 打开 IBKR 交易页面
2. 点击闪电侠扩展右上角 **⚙️ 设置** 按钮
3. 找到 **Finnhub Key** 输入框
4. 粘贴你的 API 密钥
5. 点击 **保存设置**

---

## 🎁 免费额度说明

| 计划 | 请求限额 | 包含功能 |
|------|----------|----------|
| **Free** | **60次/分钟** | ✅ 实时报价、分析师推荐、新闻 |
| Starter | 300次/分钟 | + 目标价、机构持股 |
| Pro | 600次/分钟 | + 更多历史数据 |

> **提示**：免费版的分析师推荐评级已经很有参考价值！完全够用于日常交易决策。

---

## ✅ 测试是否生效

### 方法 1：查看高级数据面板
1. 重新加载扩展（`chrome://extensions` → 重新加载）
2. 刷新 IBKR 页面
3. 点击高级数据区域的 **🔄 刷新**按钮
4. 查看以下字段是否显示数据：
   - **分析师评级**：共识状态（强烈买入/买入/持有...）✅
   - ~~目标价~~、~~机构持股~~：显示"数据不可用"（需付费版）⚠️

### 方法 2：查看 Console 日志
1. 按 `F12` 打开开发者工具
2. 切换到 **Console** 标签
3. 点击 🔄 刷新按钮
4. 查找以下日志：
   ```
   👔 使用Finnhub API获取分析师评级: TSLA
   👔 Finnhub分析师数据: {strongBuy: 5, buy: 10, hold: 3, ...}
   🏦 机构持股数据需要Finnhub付费版，返回默认值
   ```

---

## 🔍 API 调用说明

### 使用的端点（免费版）

1. **分析师推荐** ✅
   ```
   GET https://finnhub.io/api/v1/stock/recommendation?symbol={SYMBOL}&token={API_KEY}
   ```
   返回最近的分析师评级分布（强烈买入/买入/持有/卖出/强烈卖出）

2. ~~**价格目标**~~ ⚠️ 付费版
   ```
   GET https://finnhub.io/api/v1/stock/price-target?symbol={SYMBOL}&token={API_KEY}
   ```
   免费版调用会返回 **HTTP 403**

3. ~~**机构持股**~~ ⚠️ 付费版
   ```
   GET https://finnhub.io/api/v1/stock/ownership?symbol={SYMBOL}&token={API_KEY}
   ```
   免费版调用会返回 **HTTP 403**

> **说明**：扩展已自动处理403错误，不会影响其他功能正常使用。

### 缓存策略
- **分析师数据**：24小时缓存（更新频率低）
- **详细报价**：5分钟缓存（量价数据）

---

## ⚠️ 注意事项

### 1. API 密钥安全
- 密钥仅保存在**本地浏览器**（`chrome.storage.local`）
- 不会上传到任何服务器
- 定期检查API密钥是否泄露：https://finnhub.io/dashboard

### 2. 请求限额
- 免费版：60次/分钟
- 扩展已实现智能缓存，避免重复请求
- 如果达到限额，等待1分钟后自动恢复

### 3. 数据更新频率
- ~~**机构持股**~~：每季度更新（需付费版）
- ~~**价格目标**~~：分析师发布新报告时更新（需付费版）

### 4. 数据可用性
- 美股数据最完整（NYSE、NASDAQ）
- 部分小盘股可能无分析师覆盖
- 如显示"数据不可用"或"N/A"，说明该功能需要付费版或暂无
- 如显示"数据不可用"，说明该股票暂无相关数据

---

## 🛠️ 故障排查

### 问题1：点击刷新后仍显示"N/A"
**解决方案**：
1. 检查 Console 是否有错误日志
2. 确认 API 密钥正确粘贴（无多余空格）
3. 验证 Finnhub 账号状态：https://finnhub.io/dashboard
4. 检查是否达到请求限额（每分钟60次）

### 问题2：显示"Finnhub API密钥未配置"
**解决方案**：
1. 打开设置面板
2. 找到 **Finnhub Key** 输入框
3. 粘贴密钥后点击 **保存设置**
4. 重新加载扩展
或403错误
**解决方案**：
- **401**：API 密钥可能已过期或错误
  1. 登录 https://finnhub.io/dashboard 检查状态
  2. 确认密钥正确复制（无多余空格）
- **403**：访问的端点需要付费版
  1. `price-target` 需要付费版
  2. `ownership` 需要付费版
  3. 这是正常现象，扩展已自动处理dashboard 检查状态
3. 如需重新生成密钥，在Dashboard中操作

---

## 📚 更多资源

- **Finnhub 官方文档**：https://finnhub.io/docs/api
- **API 限额说明**：https://finnhub.io/pricing
- **数据字典**：https://finnhub.io/docs/api/stock-recommendation

---

## 💡 使用建议

1. **日内交易**：主要看技术指标（RSI、MACD、量价）
2. **短线持仓**：参考分析师评级和目标价
3. **中长线**：关注机构持股变化（增持是好信号）

**提示**：分析师评级和机构持股更适合中长期投资参考，日内做T主要还是看技术面和盘口！

---

## 🎉 完成！

现在你可以在扩展中看到更丰富的市场数据，帮助做出更明智的交易决策！
